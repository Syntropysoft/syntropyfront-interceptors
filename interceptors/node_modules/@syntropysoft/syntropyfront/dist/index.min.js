var SyntropyFront=function(e){"use strict";const t=new class{constructor(e=25){this.maxBreadcrumbs=e,this.breadcrumbs=[],this.agent=null}setAgent(e){this.agent=e}setMaxBreadcrumbs(e){this.maxBreadcrumbs=e,this.breadcrumbs.length>this.maxBreadcrumbs&&(this.breadcrumbs=this.breadcrumbs.slice(-this.maxBreadcrumbs))}getMaxBreadcrumbs(){return this.maxBreadcrumbs}add(e){const t={...e,timestamp:(new Date).toISOString()};this.breadcrumbs.length>=this.maxBreadcrumbs&&this.breadcrumbs.shift(),this.breadcrumbs.push(t),this.onBreadcrumbAdded&&this.onBreadcrumbAdded(t),this.agent&&this.agent.sendBreadcrumbs([t])}getAll(){return[...this.breadcrumbs]}clear(){this.breadcrumbs=[]}getByCategory(e){return this.breadcrumbs.filter(t=>t.category===e)}};const r=new class{constructor(){this.seen=new WeakSet,this.circularRefs=new Map,this.refCounter=0}serialize(e){try{this.seen=new WeakSet,this.circularRefs=new Map,this.refCounter=0;const t=this.makeSerializable(e);return JSON.stringify(t)}catch(t){return console.error("SyntropyFront: Error en serialización robusta:",t),JSON.stringify({__serializationError:!0,error:t.message,originalType:typeof e,isObject:null!==e&&"object"==typeof e,timestamp:(new Date).toISOString()})}}makeSerializable(e,t=""){if(null==e)return e;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;if(e instanceof Date)return{__type:"Date",value:e.toISOString()};if(e instanceof Error)return{__type:"Error",name:e.name,message:e.message,stack:e.stack,cause:e.cause?this.makeSerializable(e.cause,`${t}.cause`):void 0};if(e instanceof RegExp)return{__type:"RegExp",source:e.source,flags:e.flags};if(Array.isArray(e)){if(this.seen.has(e)){return{__circular:!0,refId:this.circularRefs.get(e)}}this.seen.add(e);const r="ref_"+ ++this.refCounter;return this.circularRefs.set(e,r),e.map((e,r)=>this.makeSerializable(e,`${t}[${r}]`))}if("object"==typeof e){if(this.seen.has(e)){return{__circular:!0,refId:this.circularRefs.get(e)}}this.seen.add(e);const r="ref_"+ ++this.refCounter;this.circularRefs.set(e,r);const n={};for(const r in e)if(e.hasOwnProperty(r))try{const o=e[r],s=this.makeSerializable(o,`${t}.${r}`);n[r]=s}catch(e){n[r]={__serializationError:!0,error:e.message,propertyName:r}}if(Object.getOwnPropertySymbols){const r=Object.getOwnPropertySymbols(e);for(const o of r)try{const r=e[o],s=this.makeSerializable(r,`${t}[Symbol(${o.description})]`);n[`__symbol_${o.description||"anonymous"}`]=s}catch(e){n[`__symbol_${o.description||"anonymous"}`]={__serializationError:!0,error:e.message,symbolName:o.description||"anonymous"}}}return n}return"function"==typeof e?{__type:"Function",name:e.name||"anonymous",length:e.length,toString:e.toString().substring(0,200)+"..."}:{__type:"Unknown",constructor:e.constructor?e.constructor.name:"Unknown",toString:String(e).substring(0,200)+"..."}}deserialize(e){try{const t=JSON.parse(e);return this.restoreCircularRefs(t)}catch(e){return console.error("SyntropyFront: Error en deserialización:",e),null}}restoreCircularRefs(e,t=new Map){if(null==e)return e;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;if("Date"===e.__type)return new Date(e.value);if("Error"===e.__type){const r=new Error(e.message);return r.name=e.name,r.stack=e.stack,e.cause&&(r.cause=this.restoreCircularRefs(e.cause,t)),r}if("RegExp"===e.__type)return new RegExp(e.source,e.flags);if("Function"===e.__type)return`[Function: ${e.name}]`;if(Array.isArray(e)){const r=[];t.set(e,r);for(let n=0;n<e.length;n++)if(e[n]&&e[n].__circular){const o=e[n].refId;t.has(o)?r[n]=t.get(o):r[n]=null}else r[n]=this.restoreCircularRefs(e[n],t);return r}if("object"==typeof e){const r={};t.set(e,r);for(const n in e)if(e.hasOwnProperty(n)){if(n.startsWith("__"))continue;const o=e[n];if(o&&o.__circular){const e=o.refId;t.has(e)?r[n]=t.get(e):r[n]=null}else r[n]=this.restoreCircularRefs(o,t)}return r}return e}serializeForLogging(e){try{return this.serialize(e)}catch(e){return JSON.stringify({__logError:!0,message:"Error serializando para logging",originalError:e.message,timestamp:(new Date).toISOString()})}}};const n=new class{constructor(){this.endpoint=null,this.headers={"Content-Type":"application/json"},this.batchSize=10,this.batchTimeout=null,this.queue=[],this.batchTimer=null,this.isEnabled=!1,this.sendBreadcrumbs=!1,this.encrypt=null,this.retryQueue=[],this.retryTimer=null,this.maxRetries=5,this.baseDelay=1e3,this.maxDelay=3e4,this.usePersistentBuffer=!1,this.dbName="SyntropyFrontBuffer",this.dbVersion=1,this.storeName="failedItems",this.initPersistentBuffer()}async initPersistentBuffer(){try{if(!window.indexedDB)return void console.warn("SyntropyFront: IndexedDB no disponible, usando solo memoria");const e=indexedDB.open(this.dbName,this.dbVersion);e.onerror=()=>{console.warn("SyntropyFront: Error abriendo IndexedDB, usando solo memoria")},e.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0})},e.onsuccess=()=>{this.db=e.result,this.usePersistentBuffer=!0,console.log("SyntropyFront: Buffer persistente inicializado"),this.retryFailedItems()}}catch(e){console.warn("SyntropyFront: Error inicializando buffer persistente:",e)}}async saveToPersistentBuffer(e){if(this.usePersistentBuffer&&this.db)try{const t=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName);let n;try{n=r.serialize(e)}catch(e){console.error("SyntropyFront: Error serializando items para buffer:",e),n=JSON.stringify({__serializationError:!0,error:e.message,timestamp:(new Date).toISOString(),fallbackData:"Items no serializables"})}const o={items:n,timestamp:(new Date).toISOString(),retryCount:0};await t.add(o),console.log("SyntropyFront: Items guardados en buffer persistente")}catch(e){console.error("SyntropyFront: Error guardando en buffer persistente:",e)}}async getFromPersistentBuffer(){if(!this.usePersistentBuffer||!this.db)return[];try{const e=this.db.transaction([this.storeName],"readonly"),t=e.objectStore(this.storeName).getAll();return new Promise((e,r)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error)})}catch(e){return console.error("SyntropyFront: Error obteniendo del buffer persistente:",e),[]}}async removeFromPersistentBuffer(e){if(this.usePersistentBuffer&&this.db)try{const t=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName);await t.delete(e)}catch(e){console.error("SyntropyFront: Error removiendo del buffer persistente:",e)}}async retryFailedItems(){if(!this.usePersistentBuffer)return;const e=await this.getFromPersistentBuffer();for(const t of e)if(t.retryCount<this.maxRetries){let e;try{e="string"==typeof t.items?r.deserialize(t.items):t.items}catch(e){console.error("SyntropyFront: Error deserializando items del buffer:",e),await this.removeFromPersistentBuffer(t.id);continue}this.addToRetryQueue(e,t.retryCount+1,t.id)}else console.warn("SyntropyFront: Item excedió máximo de reintentos, removiendo del buffer"),await this.removeFromPersistentBuffer(t.id)}configure(e){this.endpoint=e.endpoint,this.headers={...this.headers,...e.headers},this.batchSize=e.batchSize||this.batchSize,this.batchTimeout=e.batchTimeout,this.isEnabled=!!e.endpoint,this.encrypt=e.encrypt||null,this.usePersistentBuffer=!1!==e.usePersistentBuffer,this.maxRetries=e.maxRetries||this.maxRetries,this.sendBreadcrumbs=!!e.batchTimeout}sendError(e,t=null){if(!this.isEnabled)return void console.warn("SyntropyFront Agent: No configurado, error no enviado");const r=t?{...e,context:t}:e,n=this.encrypt?this.encrypt(r):r;this.addToQueue({type:"error",data:n,timestamp:(new Date).toISOString()})}sendBreadcrumbs(e){if(!this.isEnabled||!this.sendBreadcrumbs||!e.length)return;const t=this.encrypt?this.encrypt(e):e;this.addToQueue({type:"breadcrumbs",data:t,timestamp:(new Date).toISOString()})}addToQueue(e){this.queue.push(e),this.queue.length>=this.batchSize?this.flush():this.batchTimeout&&!this.batchTimer&&(this.batchTimer=setTimeout(()=>{this.flush()},this.batchTimeout))}addToRetryQueue(e,t=1,r=null){const n=Math.min(this.baseDelay*Math.pow(2,t-1),this.maxDelay);this.retryQueue.push({items:e,retryCount:t,persistentId:r,nextRetry:Date.now()+n}),this.scheduleRetry()}scheduleRetry(){if(this.retryTimer)return;const e=this.retryQueue.find(e=>e.nextRetry<=Date.now());e&&(this.retryTimer=setTimeout(()=>{this.processRetryQueue()},Math.max(0,e.nextRetry-Date.now())))}async processRetryQueue(){this.retryTimer=null;const e=Date.now(),t=this.retryQueue.filter(t=>t.nextRetry<=e);for(const e of t)try{await this.sendToBackend(e.items),this.retryQueue=this.retryQueue.filter(t=>t!==e),e.persistentId&&await this.removeFromPersistentBuffer(e.persistentId),console.log(`SyntropyFront: Reintento exitoso después de ${e.retryCount} intentos`)}catch(t){console.warn(`SyntropyFront: Reintento ${e.retryCount} falló:`,t),e.retryCount>=this.maxRetries?(this.retryQueue=this.retryQueue.filter(t=>t!==e),console.error("SyntropyFront: Item excedió máximo de reintentos, datos perdidos")):(e.retryCount++,e.nextRetry=Date.now()+Math.min(this.baseDelay*Math.pow(2,e.retryCount-1),this.maxDelay))}this.retryQueue.length>0&&this.scheduleRetry()}async flush(){if(0===this.queue.length)return;const e=[...this.queue];this.queue=[],this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);try{await this.sendToBackend(e),console.log("SyntropyFront: Datos enviados exitosamente")}catch(t){console.error("SyntropyFront Agent: Error enviando datos:",t),this.addToRetryQueue(e),this.usePersistentBuffer&&await this.saveToPersistentBuffer(e)}}async sendToBackend(e){const t={timestamp:(new Date).toISOString(),items:e};let n;try{n=r.serialize(t)}catch(t){console.error("SyntropyFront: Error en serialización del payload:",t),n=JSON.stringify({__serializationError:!0,error:t.message,timestamp:(new Date).toISOString(),itemsCount:e.length,fallbackData:"Serialización falló, datos no enviados"})}const o=await fetch(this.endpoint,{method:"POST",headers:this.headers,body:n});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.json()}async forceFlush(){await this.flush(),this.retryQueue.length>0&&(console.log("SyntropyFront: Intentando enviar items en cola de reintentos..."),await this.processRetryQueue())}getStats(){return{queueLength:this.queue.length,retryQueueLength:this.retryQueue.length,isEnabled:this.isEnabled,usePersistentBuffer:this.usePersistentBuffer,maxRetries:this.maxRetries}}disable(){this.isEnabled=!1,this.queue=[],this.retryQueue=[],this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}};const o=new class{constructor(){this.defaultContexts={device:{userAgent:()=>navigator.userAgent,language:()=>navigator.language,screen:()=>({width:window.screen.width,height:window.screen.height}),timezone:()=>Intl.DateTimeFormat().resolvedOptions().timeZone},window:{url:()=>window.location.href,viewport:()=>({width:window.innerWidth,height:window.innerHeight}),title:()=>document.title},session:{sessionId:()=>this.generateSessionId(),pageLoadTime:()=>performance.now()},ui:{visibility:()=>document.visibilityState,activeElement:()=>document.activeElement?{tagName:document.activeElement.tagName}:null},network:{online:()=>navigator.onLine,connection:()=>navigator.connection?{effectiveType:navigator.connection.effectiveType}:null}},this.allFields={device:{userAgent:()=>navigator.userAgent,language:()=>navigator.language,languages:()=>navigator.languages,screen:()=>({width:window.screen.width,height:window.screen.height,availWidth:window.screen.availWidth,availHeight:window.screen.availHeight,colorDepth:window.screen.colorDepth,pixelDepth:window.screen.pixelDepth}),timezone:()=>Intl.DateTimeFormat().resolvedOptions().timeZone,cookieEnabled:()=>navigator.cookieEnabled,doNotTrack:()=>navigator.doNotTrack},window:{url:()=>window.location.href,pathname:()=>window.location.pathname,search:()=>window.location.search,hash:()=>window.location.hash,referrer:()=>document.referrer,title:()=>document.title,viewport:()=>({width:window.innerWidth,height:window.innerHeight})},storage:{localStorage:()=>{const e=Object.keys(localStorage);return{keys:e.length,size:JSON.stringify(localStorage).length,keyNames:e}},sessionStorage:()=>{const e=Object.keys(sessionStorage);return{keys:e.length,size:JSON.stringify(sessionStorage).length,keyNames:e}}},network:{online:()=>navigator.onLine,connection:()=>navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null},ui:{focused:()=>document.hasFocus(),visibility:()=>document.visibilityState,activeElement:()=>document.activeElement?{tagName:document.activeElement.tagName,id:document.activeElement.id,className:document.activeElement.className}:null},performance:{memory:()=>window.performance&&window.performance.memory?{used:Math.round(window.performance.memory.usedJSHeapSize/1048576),total:Math.round(window.performance.memory.totalJSHeapSize/1048576),limit:Math.round(window.performance.memory.jsHeapSizeLimit/1048576)}:null,timing:()=>window.performance?{navigationStart:window.performance.timing.navigationStart,loadEventEnd:window.performance.timing.loadEventEnd}:null},session:{sessionId:()=>this.generateSessionId(),startTime:()=>(new Date).toISOString(),pageLoadTime:()=>performance.now()}}}collect(e={}){const t={};return Object.entries(e).forEach(([e,r])=>{try{!0===r?t[e]=this.collectDefaultContext(e):Array.isArray(r)?t[e]=this.collectSpecificFields(e,r):!1===r||console.warn(`SyntropyFront: Configuración de contexto inválida para ${e}:`,r)}catch(r){console.warn(`SyntropyFront: Error recolectando contexto ${e}:`,r),t[e]={error:"Failed to collect"}}}),t}collectDefaultContext(e){const t=this.defaultContexts[e];if(!t)return console.warn(`SyntropyFront: No hay set por defecto para ${e}`),{};const r={};return Object.entries(t).forEach(([t,n])=>{try{r[t]=n()}catch(n){console.warn(`SyntropyFront: Error recolectando campo ${t} de ${e}:`,n),r[t]=null}}),r}collectSpecificFields(e,t){const r=this.allFields[e];if(!r)return console.warn(`SyntropyFront: Tipo de contexto desconocido: ${e}`),{};const n={};return t.forEach(t=>{try{r[t]?n[t]=r[t]():console.warn(`SyntropyFront: Campo ${t} no disponible en ${e}`)}catch(r){console.warn(`SyntropyFront: Error recolectando campo ${t} de ${e}:`,r),n[t]=null}}),n}generateSessionId(){return this._sessionId||(this._sessionId="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)),this._sessionId}getAvailableTypes(){return Object.keys(this.allFields)}getAvailableFields(e){const t=this.allFields[e];return t?Object.keys(t):[]}getDefaultContextsInfo(){const e={};return Object.entries(this.defaultContexts).forEach(([t,r])=>{e[t]=Object.keys(r)}),e}};const s=new class{constructor(){this.isInitialized=!1,this.config={captureClicks:!0,captureFetch:!0,captureErrors:!0,captureUnhandledRejections:!0},this.contextTypes=[],this.originalHandlers={fetch:null,onerror:null,onunhandledrejection:null},this.eventListeners=new Map}configure(e){this.config={...this.config,...e},this.contextTypes=e.context||[]}init(){this.isInitialized?console.warn("SyntropyFront: Interceptors ya están inicializados"):(this.config.captureClicks&&this.setupClickInterceptor(),this.config.captureFetch&&this.setupFetchInterceptor(),(this.config.captureErrors||this.config.captureUnhandledRejections)&&this.setupErrorInterceptors(),this.isInitialized=!0,console.log("SyntropyFront: Interceptors inicializados con Chaining Pattern"))}setupClickInterceptor(){const e=e=>{const r=e.target;if(!r)return;let n=r.tagName.toLowerCase();r.id?n+=`#${r.id}`:r.className&&"string"==typeof r.className&&(n+=`.${r.className.split(" ").filter(Boolean).join(".")}`),t.add({category:"ui",message:`Usuario hizo click en '${n}'`,data:{selector:n,tagName:r.tagName,id:r.id,className:r.className}})};this.eventListeners.set("click",e),document.addEventListener("click",e,!0)}setupFetchInterceptor(){this.originalHandlers.fetch=window.fetch;window.fetch=(...e)=>{const r=e[0]instanceof Request?e[0].url:e[0],n=e[0]instanceof Request?e[0].method:e[1]?.method||"GET";return t.add({category:"network",message:`Request: ${n} ${r}`,data:{url:r,method:n,timestamp:Date.now()}}),this.originalHandlers.fetch.apply(window,e)}}setupErrorInterceptors(){if(this.config.captureErrors){this.originalHandlers.onerror=window.onerror;const e=(e,r,n,o,s)=>{const i={type:"uncaught_exception",error:{message:e,source:r,lineno:n,colno:o,stack:s?.stack},breadcrumbs:t.getAll(),timestamp:(new Date).toISOString()};if(this.handleError(i),this.originalHandlers.onerror)try{return this.originalHandlers.onerror(e,r,n,o,s)}catch(e){return console.warn("SyntropyFront: Error en handler original:",e),!1}return!1};window.onerror=e}if(this.config.captureUnhandledRejections){this.originalHandlers.onunhandledrejection=window.onunhandledrejection;const e=e=>{const r={type:"unhandled_rejection",error:{message:e.reason?.message||"Rechazo de promesa sin mensaje",stack:e.reason?.stack},breadcrumbs:t.getAll(),timestamp:(new Date).toISOString()};if(this.handleError(r),this.originalHandlers.onunhandledrejection)try{this.originalHandlers.onunhandledrejection(e)}catch(e){console.warn("SyntropyFront: Error en handler original de rejection:",e)}};window.onunhandledrejection=e}}handleError(e){const t=this.contextTypes.length>0?o.collect(this.contextTypes):null;n.sendError(e,t),this.onError?this.onError(e):console.error("SyntropyFront - Error detectado:",e)}destroy(){this.isInitialized&&(console.log("SyntropyFront: Limpiando interceptores..."),this.originalHandlers.fetch&&(window.fetch=this.originalHandlers.fetch,console.log("SyntropyFront: fetch original restaurado")),this.originalHandlers.onerror&&(window.onerror=this.originalHandlers.onerror,console.log("SyntropyFront: onerror original restaurado")),this.originalHandlers.onunhandledrejection&&(window.onunhandledrejection=this.originalHandlers.onunhandledrejection,console.log("SyntropyFront: onunhandledrejection original restaurado")),this.eventListeners.forEach((e,t)=>{document.removeEventListener(t,e,!0),console.log(`SyntropyFront: Event listener ${t} removido`)}),this.originalHandlers={fetch:null,onerror:null,onunhandledrejection:null},this.eventListeners.clear(),this.isInitialized=!1,console.log("SyntropyFront: Interceptors destruidos y handlers restaurados"))}getHandlerInfo(){return{isInitialized:this.isInitialized,hasOriginalFetch:!!this.originalHandlers.fetch,hasOriginalOnError:!!this.originalHandlers.onerror,hasOriginalOnUnhandledRejection:!!this.originalHandlers.onunhandledrejection,eventListenersCount:this.eventListeners.size}}},i={safe:{name:"safe",description:"Modo solo emergencias - Mínimo impacto, máxima privacidad",agent:{batchTimeout:null,batchSize:5,encrypt:null},maxBreadcrumbs:10,context:{device:!0,window:!1,session:!0,ui:!1,network:!1},customObjects:{},proxyTracking:!1,captureClicks:!1,captureFetch:!1,captureErrors:!0,captureUnhandledRejections:!0,useWorker:!1,onError:null,onBreadcrumbAdded:null},balanced:{name:"balanced",description:"Modo equilibrado - Balance entre información y performance",agent:{batchTimeout:1e4,batchSize:20,encrypt:null},maxBreadcrumbs:50,context:{device:!0,window:!0,session:!0,ui:!0,network:!0},customObjects:{},proxyTracking:{enabled:!0,maxStates:10,trackNested:!0,trackArrays:!1},captureClicks:!0,captureFetch:!0,captureErrors:!0,captureUnhandledRejections:!0,useWorker:!0,onError:null,onBreadcrumbAdded:null},debug:{name:"debug",description:"Modo debug completo - Máxima información para desarrollo",agent:{batchTimeout:5e3,batchSize:50,encrypt:null},maxBreadcrumbs:100,context:{device:!0,window:!0,session:!0,ui:!0,network:!0},customObjects:{},proxyTracking:{enabled:!0,maxStates:20,trackNested:!0,trackArrays:!0,trackFunctions:!0},captureClicks:!0,captureFetch:!0,captureErrors:!0,captureUnhandledRejections:!0,useWorker:!0,onError:e=>{console.error("SyntropyFront Error:",e)},onBreadcrumbAdded:e=>{console.log("SyntropyFront Breadcrumb:",e)}},performance:{name:"performance",description:"Modo performance - Máxima velocidad, información mínima",agent:{batchTimeout:null,batchSize:3,encrypt:null},maxBreadcrumbs:5,context:{device:!1,window:!1,session:!0,ui:!1,network:!1},customObjects:{},proxyTracking:!1,captureClicks:!1,captureFetch:!1,captureErrors:!0,captureUnhandledRejections:!0,useWorker:!1,onError:null,onBreadcrumbAdded:null}};function a(e){const t=i[e];if(!t)throw new Error(`Preset '${e}' no encontrado. Presets disponibles: ${Object.keys(i).join(", ")}`);return t}class c{constructor(){this.isInitialized=!1,this.currentPreset=null,this.proxyObjectTracker=null,this.interceptorRegistry=null,this.workerManager=null,this.config={preset:"balanced",maxBreadcrumbs:50,captureClicks:!0,captureFetch:!0,captureErrors:!0,captureUnhandledRejections:!0,onError:null,onBreadcrumbAdded:null,agent:{endpoint:null,headers:{},batchSize:20,batchTimeout:1e4,encrypt:null},context:{device:!0,window:!0,session:!0,ui:!0,network:!0},proxyTracking:{enabled:!0,maxStates:10,trackNested:!0,trackArrays:!1},useWorker:!0}}async init(e={}){if(this.isInitialized)console.warn("SyntropyFront ya está inicializado");else{if(e.preset)try{const t=a(e.preset);this.currentPreset=e.preset,this.config={...this.config,...t},console.log(`🎯 SyntropyFront: Aplicando preset '${e.preset}' - ${t.description}`)}catch(t){throw console.error(`❌ SyntropyFront: Error aplicando preset '${e.preset}':`,t.message),t}this.config={...this.config,...e},this.config.agent.endpoint&&n.configure(this.config.agent),!1!==this.config.useWorker&&await this.workerManager.init({maxBreadcrumbs:this.config.maxBreadcrumbs,agent:this.config.agent}),t.setMaxBreadcrumbs(this.config.maxBreadcrumbs),t.onBreadcrumbAdded=this.config.onBreadcrumbAdded,t.setAgent(n),this.contextConfig=this.config.context||{device:!0,window:!0,session:!0,ui:!0,network:!0},await this.loadModules(),this.config.proxyTracking?.enabled&&this.proxyObjectTracker&&this.proxyObjectTracker.configure(this.config.proxyTracking),s.configure({captureClicks:this.config.captureClicks,captureFetch:this.config.captureFetch,captureErrors:this.config.captureErrors,captureUnhandledRejections:this.config.captureUnhandledRejections}),s.onError=this.config.onError,s.init(),this.interceptorRegistry&&this.interceptorRegistry.init({breadcrumbStore:t,agent:n,contextCollector:o}),this.isInitialized=!0,console.log("SyntropyFront inicializado correctamente")}}async loadModules(){const e=[];this.config.proxyTracking?.enabled&&e.push(Promise.resolve().then(function(){return h}).then(e=>{this.proxyObjectTracker=e.proxyObjectTracker,console.log("🔄 ProxyObjectTracker cargado dinámicamente")}).catch(e=>{console.warn("⚠️ Error cargando ProxyObjectTracker:",e)})),!1!==this.config.useInterceptors&&e.push(Promise.resolve().then(function(){return p}).then(e=>{this.interceptorRegistry=e.interceptorRegistry,console.log("🔄 InterceptorRegistry cargado dinámicamente")}).catch(e=>{console.warn("⚠️ Error cargando InterceptorRegistry:",e)})),!1!==this.config.useWorker&&e.push(Promise.resolve().then(function(){return m}).then(e=>{this.workerManager=new e.default,console.log("🔄 WorkerManager cargado dinámicamente")}).catch(e=>{console.warn("⚠️ Error cargando WorkerManager:",e)})),await Promise.all(e)}addBreadcrumb(e,r,n={}){t.add({category:e,message:r,data:n})}getBreadcrumbs(){return t.getAll()}getBreadcrumbsByCategory(e){return t.getByCategory(e)}clearBreadcrumbs(){t.clear()}destroy(){this.isInitialized&&(s.destroy(),this.interceptorRegistry&&this.interceptorRegistry.destroy(),t.clear(),n.disable(),this.workerManager&&this.workerManager.destroy(),this.isInitialized=!1,console.log("SyntropyFront desactivado"))}setMaxBreadcrumbs(e){t.setMaxBreadcrumbs(e)}getMaxBreadcrumbs(){return t.getMaxBreadcrumbs()}async flush(){await n.forceFlush()}getContext(){const e=o.collect(this.contextConfig),t=customObjectCollector.collectCustomObjects();return Object.keys(t).length>0&&(e.customObjects=t),e}getAvailableContextTypes(){return o.getAvailableTypes()}getAvailableContextFields(e){return o.getAvailableFields(e)}getDefaultContextsInfo(){return o.getDefaultContextsInfo()}setContext(e){"object"==typeof e?(this.contextConfig=e,console.log("SyntropyFront: Configuración de contexto actualizada:",e)):console.warn("SyntropyFront: contextConfig debe ser un objeto")}setContextTypes(e){if(!Array.isArray(e))return void console.warn("SyntropyFront: contextTypes debe ser un array");const t={};e.forEach(e=>{t[e]=!0}),this.setContext(t)}addCustomObject(e,t,r=10){throw console.warn("SyntropyFront: addCustomObject() está deprecado. Usa addProxyObject() en su lugar."),new Error("addCustomObject() está deprecado. Usa addProxyObject() en su lugar.")}removeCustomObject(e){throw console.warn("SyntropyFront: removeCustomObject() está deprecado. Usa removeProxyObject() en su lugar."),new Error("removeCustomObject() está deprecado. Usa removeProxyObject() en su lugar.")}getCustomObjectValue(e){throw console.warn("SyntropyFront: getCustomObjectValue() está deprecado. Usa getProxyObjectState() en su lugar."),new Error("getCustomObjectValue() está deprecado. Usa getProxyObjectState() en su lugar.")}getCustomObjectHistory(e){throw console.warn("SyntropyFront: getCustomObjectHistory() está deprecado. Usa getProxyObjectHistory() en su lugar."),new Error("getCustomObjectHistory() está deprecado. Usa getProxyObjectHistory() en su lugar.")}getCustomObjectNames(){throw console.warn("SyntropyFront: getCustomObjectNames() está deprecado. Usa getProxyTrackedObjects() en su lugar."),new Error("getCustomObjectNames() está deprecado. Usa getProxyTrackedObjects() en su lugar.")}inject(e,t){return this.interceptorRegistry?(this.interceptorRegistry.register(e,t),this):(console.warn("SyntropyFront: InterceptorRegistry no está cargado. Asegúrate de que useInterceptors no esté en false."),this)}removeInterceptor(e){this.interceptorRegistry?this.interceptorRegistry.unregister(e):console.warn("SyntropyFront: InterceptorRegistry no está cargado.")}getRegisteredInterceptors(){return this.interceptorRegistry?this.interceptorRegistry.getRegisteredInterceptors():[]}getInterceptorInfo(e){return this.interceptorRegistry?this.interceptorRegistry.getInterceptorInfo(e):null}isActive(){return this.isInitialized}addProxyObject(e,t,r={}){return this.proxyObjectTracker?this.proxyObjectTracker.addObject(e,t,r):(console.warn("SyntropyFront: ProxyObjectTracker no está cargado. Asegúrate de que proxyTracking.enabled esté en true."),t)}getProxyObjectHistory(e){return this.proxyObjectTracker?this.proxyObjectTracker.getObjectHistory(e):[]}getProxyObjectState(e){return this.proxyObjectTracker?this.proxyObjectTracker.getCurrentState(e):null}getProxyTrackedObjects(){return this.proxyObjectTracker?this.proxyObjectTracker.getTrackedObjects():[]}removeProxyObject(e){return this.proxyObjectTracker?this.proxyObjectTracker.removeObject(e):null}clearProxyObjects(){this.proxyObjectTracker&&this.proxyObjectTracker.clear()}getProxyTrackerStats(){return this.proxyObjectTracker?this.proxyObjectTracker.getStats():{enabled:!1,trackedObjects:0}}async addBreadcrumbToWorker(e,t,r={}){return this.workerManager?this.workerManager.isWorkerAvailable()?await this.workerManager.addBreadcrumb(e,t,r):this.addBreadcrumb(e,t,r):(console.warn("SyntropyFront: WorkerManager no está cargado. Asegúrate de que useWorker no esté en false."),this.addBreadcrumb(e,t,r))}async getBreadcrumbsFromWorker(){return this.workerManager&&this.workerManager.isWorkerAvailable()?await this.workerManager.getBreadcrumbs():this.getBreadcrumbs()}async clearBreadcrumbsFromWorker(){return this.workerManager&&this.workerManager.isWorkerAvailable()?await this.workerManager.clearBreadcrumbs():this.clearBreadcrumbs()}async sendErrorToWorker(e,t={}){return this.workerManager?this.workerManager.isWorkerAvailable()?await this.workerManager.sendError(e,t):this.sendError(e,t):(console.warn("SyntropyFront: WorkerManager no está cargado. Asegúrate de que useWorker no esté en false."),this.sendError(e,t))}async pingWorker(){return this.workerManager?this.workerManager.isWorkerAvailable()?await this.workerManager.ping():{success:!1,message:"Worker no disponible"}:{success:!1,message:"Worker no cargado"}}getWorkerStatus(){return this.workerManager?this.workerManager.getStatus():{isAvailable:!1,isInitialized:!1,pendingRequests:0}}isWorkerAvailable(){return!!this.workerManager&&this.workerManager.isWorkerAvailable()}getCurrentPreset(){return this.currentPreset}getPresetInfo(e=null){const t=e||this.currentPreset;return t?function(e){const t=a(e);return{name:t.name,description:t.description,features:{breadcrumbs:t.maxBreadcrumbs,context:Object.keys(t.context).filter(e=>t.context[e]).length,worker:t.useWorker,proxyTracking:t.proxyTracking?.enabled||!1,agentMode:t.agent.batchTimeout?"completo":"solo emergencias"}}}(t):null}getAvailablePresets(){return Object.keys(i).map(e=>({name:e,...i[e]}))}async changePreset(e,t={}){if(this.isInitialized)return console.warn("SyntropyFront: No se puede cambiar preset después de la inicialización"),!1;try{const r=a(e);return this.currentPreset=e,this.config={...this.config,...r},this.config={...this.config,...t},console.log(`🎯 SyntropyFront: Preset cambiado a '${e}' - ${r.description}`),!0}catch(t){return console.error(`❌ SyntropyFront: Error cambiando preset a '${e}':`,t.message),!1}}getConfiguration(){return{currentPreset:this.currentPreset,config:this.config,isInitialized:this.isInitialized}}}const l=new c;class d{constructor(){this.trackedObjects=new Map,this.maxStates=10,this.isEnabled=!0,this.onChangeCallback=null}configure(e={}){this.maxStates=e.maxStates||this.maxStates,this.onChangeCallback=e.onChange||null,this.isEnabled=!1!==e.enabled}addObject(e,t,r={}){if(!this.isEnabled)return console.warn("SyntropyFront: ProxyObjectTracker deshabilitado"),t;if(!t||"object"!=typeof t)return console.warn(`SyntropyFront: Objeto inválido para tracking: ${e}`),t;if(this.trackedObjects.has(e))return console.warn(`SyntropyFront: Objeto ya está siendo trackeado: ${e}`),this.trackedObjects.get(e).proxy;try{const n={objectPath:e,originalObject:t,states:[{value:this.deepClone(t),timestamp:(new Date).toISOString(),changeType:"initial"}],proxy:null,options:{trackNested:!1!==r.trackNested,trackArrays:!1!==r.trackArrays,trackFunctions:!1!==r.trackFunctions,maxDepth:r.maxDepth||5}},o=this.createProxy(t,n);return n.proxy=o,this.trackedObjects.set(e,n),console.log(`SyntropyFront: Objeto agregado para tracking reactivo: ${e}`),o}catch(r){return console.error(`SyntropyFront: Error creando proxy para ${e}:`,r),t}}createProxy(e,t,r=0){const{objectPath:n,options:o}=t;return new Proxy(e,{get:(e,n)=>{const s=e[n];if(o.trackNested&&r<o.maxDepth&&s&&"object"==typeof s&&!(s instanceof Date)&&!(s instanceof RegExp)&&!(s instanceof Error)){if(Array.isArray(s)&&o.trackArrays)return this.createArrayProxy(s,t,r+1);if(!Array.isArray(s))return this.createProxy(s,t,r+1)}return s},set:(e,r,o)=>{const s=e[r];return this.isEqual(s,o)||(this.saveState(t,"property_change",{property:r,oldValue:this.deepClone(s),newValue:this.deepClone(o),path:`${n}.${r}`}),e[r]=o,this.notifyChange(t,r,s,o)),!0},deleteProperty:(e,r)=>{const o=e[r];this.saveState(t,"property_deleted",{property:r,oldValue:this.deepClone(o),path:`${n}.${r}`});const s=delete e[r];return this.notifyChange(t,r,o,void 0),s}})}createArrayProxy(e,t,r=0){const{objectPath:n,options:o}=t;return new Proxy(e,{get:(e,s)=>{const i=e[s];return"function"==typeof i&&this.isArrayMutator(s)?(...r)=>{this.saveState(t,"array_mutation",{method:s,arguments:r,oldArray:this.deepClone(e),path:n});const o=i.apply(e,r);return this.notifyChange(t,s,null,e),o}:!(o.trackNested&&r<o.maxDepth&&i&&"object"==typeof i)||Array.isArray(i)||i instanceof Date||i instanceof RegExp||i instanceof Error?i:this.createProxy(i,t,r+1)},set:(e,r,o)=>{const s=e[r];return this.isEqual(s,o)||(this.saveState(t,"array_element_change",{index:r,oldValue:this.deepClone(s),newValue:this.deepClone(o),path:`${n}[${r}]`}),e[r]=o,this.notifyChange(t,r,s,o)),!0}})}isArrayMutator(e){return["push","pop","shift","unshift","splice","reverse","sort","fill","copyWithin"].includes(e)}saveState(e,t,r={}){const n={value:this.deepClone(e.originalObject),timestamp:(new Date).toISOString(),changeType:t,changeData:r};e.states.push(n),e.states.length>this.maxStates&&e.states.shift()}notifyChange(e,t,r,n){if(this.onChangeCallback)try{this.onChangeCallback({objectPath:e.objectPath,property:t,oldValue:r,newValue:n,timestamp:(new Date).toISOString(),states:e.states.length})}catch(e){console.error("SyntropyFront: Error en callback de cambio:",e)}}getObjectHistory(e){const t=this.trackedObjects.get(e);return t?[...t.states]:(console.warn(`SyntropyFront: Objeto no encontrado: ${e}`),[])}getCurrentState(e){const t=this.trackedObjects.get(e);return t?{value:this.deepClone(t.originalObject),timestamp:(new Date).toISOString(),statesCount:t.states.length}:null}getTrackedObjects(){return Array.from(this.trackedObjects.keys())}removeObject(e){const t=this.trackedObjects.get(e);return t?(this.trackedObjects.delete(e),console.log(`SyntropyFront: Objeto removido del tracking: ${e}`),t.originalObject):null}clear(){this.trackedObjects.clear(),console.log("SyntropyFront: Todos los objetos removidos del tracking")}getStats(){const e={trackedObjects:this.trackedObjects.size,totalStates:0,isEnabled:this.isEnabled,maxStates:this.maxStates};for(const t of this.trackedObjects.values())e.totalStates+=t.states.length;return e}deepClone(e){if(null==e)return e;if("object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e.source,e.flags);if(e instanceof Error){const t=new Error(e.message);return t.name=e.name,t.stack=e.stack,e.cause&&(t.cause=this.deepClone(e.cause)),t}if(Array.isArray(e))return e.map(e=>this.deepClone(e));const t={};for(const r in e)e.hasOwnProperty(r)&&(t[r]=this.deepClone(e[r]));return t}isEqual(e,t){if(e===t)return!0;if(null===e||null===t)return e===t;if(typeof e!=typeof t)return!1;if("object"!=typeof e)return e===t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const o of r){if(!n.includes(o))return!1;if(e[o]!==t[o])return!1}return!0}}const u=new d;var h=Object.freeze({__proto__:null,ProxyObjectTracker:d,proxyObjectTracker:u});class g{constructor(){this.customInterceptors=new Map,this.isInitialized=!1}createInterceptorApi(e){const{breadcrumbStore:t,agent:r,contextCollector:n}=e;return{addBreadcrumb:(e,r,n={})=>{t.add({category:e,message:r,data:n,timestamp:(new Date).toISOString()})},sendError:(e,t=null)=>{r.sendError(e,t)},sendBreadcrumbs:e=>{r.sendBreadcrumbs(e)},getContext:(e={})=>n.collect(e),getTimestamp:()=>(new Date).toISOString(),apiVersion:"1.0.0",availableMethods:["addBreadcrumb","sendError","sendBreadcrumbs","getContext","getTimestamp"]}}register(e,t){if(!t||"function"!=typeof t.init)throw new Error(`Interceptor ${e} debe tener un método init()`);this.customInterceptors.set(e,{name:e,interceptor:t,enabled:!0}),console.log(`SyntropyFront: Interceptor personalizado registrado: ${e}`)}unregister(e){const t=this.customInterceptors.get(e);if(t){if(this.isInitialized&&t.interceptor.destroy)try{t.interceptor.destroy()}catch(t){console.warn(`SyntropyFront: Error destruyendo interceptor ${e}:`,t)}this.customInterceptors.delete(e),console.log(`SyntropyFront: Interceptor personalizado removido: ${e}`)}}init(e={}){if(this.isInitialized)return void console.warn("SyntropyFront: InterceptorRegistry ya está inicializado");const t=this.createInterceptorApi(e);for(const[e,r]of this.customInterceptors)if(r.enabled)try{r.interceptor.init(t),console.log(`SyntropyFront: Interceptor ${e} inicializado`)}catch(t){console.error(`SyntropyFront: Error inicializando interceptor ${e}:`,t)}this.isInitialized=!0}destroy(){if(this.isInitialized){for(const[e,t]of this.customInterceptors)if(t.interceptor.destroy)try{t.interceptor.destroy(),console.log(`SyntropyFront: Interceptor ${e} destruido`)}catch(t){console.warn(`SyntropyFront: Error destruyendo interceptor ${e}:`,t)}this.isInitialized=!1}}setEnabled(e,t){const r=this.customInterceptors.get(e);if(r&&(r.enabled=t,this.isInitialized))if(t&&r.interceptor.init)try{const t=this.createInterceptorApi({breadcrumbStore:this.breadcrumbStore,agent:this.agent,contextCollector:this.contextCollector});r.interceptor.init(t),console.log(`SyntropyFront: Interceptor ${e} habilitado`)}catch(t){console.error(`SyntropyFront: Error habilitando interceptor ${e}:`,t)}else if(!t&&r.interceptor.destroy)try{r.interceptor.destroy(),console.log(`SyntropyFront: Interceptor ${e} deshabilitado`)}catch(t){console.warn(`SyntropyFront: Error deshabilitando interceptor ${e}:`,t)}}getRegisteredInterceptors(){return Array.from(this.customInterceptors.keys())}getInterceptorInfo(e){const t=this.customInterceptors.get(e);return t?{name:t.name,enabled:t.enabled,hasInit:"function"==typeof t.interceptor.init,hasDestroy:"function"==typeof t.interceptor.destroy}:null}getApiDocumentation(){return{version:"1.0.0",methods:{addBreadcrumb:{description:"Agrega un breadcrumb al historial",signature:"addBreadcrumb(category, message, data?)",example:'api.addBreadcrumb("ui", "Usuario hizo click", { element: "button" })'},sendError:{description:"Envía un error al backend",signature:"sendError(errorPayload, context?)",example:'api.sendError({ message: "Error crítico" }, { device: true })'},sendBreadcrumbs:{description:"Envía breadcrumbs al backend",signature:"sendBreadcrumbs(breadcrumbs)",example:'api.sendBreadcrumbs([{ category: "ui", message: "Click" }])'},getContext:{description:"Obtiene contexto del navegador",signature:"getContext(contextConfig?)",example:'api.getContext({ device: true, window: ["url"] })'},getTimestamp:{description:"Obtiene timestamp actual en formato ISO",signature:"getTimestamp()",example:"const now = api.getTimestamp()"}}}}clear(){this.destroy(),this.customInterceptors.clear()}}const y=new g;var p=Object.freeze({__proto__:null,InterceptorRegistry:g,interceptorRegistry:y});var m=Object.freeze({__proto__:null,default:class{constructor(){this.worker=null,this.pendingRequests=new Map,this.requestId=0,this.isInitialized=!1,this.config={},this.setupWorker()}setupWorker(){try{this.worker=new Worker("./src/workers/SyntropyWorker.js"),this.worker.addEventListener("message",e=>{this.handleWorkerMessage(e.data)}),this.worker.addEventListener("error",e=>{console.error("SyntropyWorker error:",e),this.handleWorkerError(e)}),console.log("🔄 WorkerManager: Worker inicializado")}catch(e){console.error("WorkerManager: Error inicializando worker:",e),this.handleWorkerUnavailable()}}async init(e){try{this.config=e;const t=await this.sendMessage("INIT",e);if(t.success)return this.isInitialized=!0,console.log("✅ WorkerManager: Worker inicializado correctamente"),!0;throw new Error(t.error||"Error inicializando worker")}catch(e){return console.error("WorkerManager: Error en init:",e),!1}}sendMessage(e,t={}){return new Promise((r,n)=>{if(!this.worker)return void n(new Error("Worker no disponible"));const o=this.generateRequestId();this.pendingRequests.set(o,{resolve:r,reject:n}),this.worker.postMessage({type:e,payload:t,id:o}),setTimeout(()=>{this.pendingRequests.has(o)&&(this.pendingRequests.delete(o),n(new Error(`Timeout en request: ${e}`)))},5e3)})}handleWorkerMessage(e){const{id:t,success:r,error:n,...o}=e,s=this.pendingRequests.get(t);s?(this.pendingRequests.delete(t),r?s.resolve(o):s.reject(new Error(n||"Error en worker"))):console.warn("WorkerManager: Respuesta sin request pendiente:",t)}handleWorkerError(e){console.error("WorkerManager: Error del worker:",e),this.pendingRequests.forEach(e=>{e.reject(new Error("Worker error"))}),this.pendingRequests.clear(),this.handleWorkerUnavailable()}handleWorkerUnavailable(){console.warn("WorkerManager: Worker no disponible, usando fallback")}async addBreadcrumb(e,t,r={}){try{return await this.sendMessage("ADD_BREADCRUMB",{type:e,message:t,data:r})}catch(e){throw console.error("WorkerManager: Error agregando breadcrumb:",e),e}}async getBreadcrumbs(){try{return(await this.sendMessage("GET_BREADCRUMBS")).breadcrumbs||[]}catch(e){return console.error("WorkerManager: Error obteniendo breadcrumbs:",e),[]}}async clearBreadcrumbs(){try{return await this.sendMessage("CLEAR_BREADCRUMBS")}catch(e){throw console.error("WorkerManager: Error limpiando breadcrumbs:",e),e}}async sendError(e,t={}){try{return await this.sendMessage("SEND_ERROR",{error:e,context:t})}catch(e){throw console.error("WorkerManager: Error enviando error:",e),e}}async updateContext(e){try{return await this.sendMessage("UPDATE_CONTEXT",e)}catch(e){throw console.error("WorkerManager: Error actualizando contexto:",e),e}}async ping(){try{return await this.sendMessage("PING")}catch(e){throw console.error("WorkerManager: Error en ping:",e),e}}async getWorkerStats(){try{return await this.sendMessage("GET_STATS")}catch(e){return console.error("WorkerManager: Error obteniendo stats:",e),null}}destroy(){this.worker&&(this.pendingRequests.forEach(e=>{e.reject(new Error("Worker destroyed"))}),this.pendingRequests.clear(),this.worker.terminate(),this.worker=null,console.log("🔄 WorkerManager: Worker destruido"))}generateRequestId(){return`req_${++this.requestId}_${Date.now()}`}isWorkerAvailable(){return null!==this.worker&&this.isInitialized}getStatus(){return{isAvailable:this.isWorkerAvailable(),isInitialized:this.isInitialized,pendingRequests:this.pendingRequests.size,config:this.config}}}});return e.SyntropyFront=c,e.agent=n,e.breadcrumbStore=t,e.default=l,e.interceptors=s,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=index.min.js.map
